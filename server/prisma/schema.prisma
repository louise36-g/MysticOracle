// Prisma Schema for MysticOracle
// Database: PostgreSQL on Render (Frankfurt EU)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION (synced with Clerk)
// ============================================

model User {
  id                String   @id // Clerk user ID
  email             String   @unique
  username          String   @unique
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Profile
  language          String   @default("en") // 'en' | 'fr'

  // Credits & Economy
  credits           Int      @default(3)
  totalCreditsEarned Int     @default(3)
  totalCreditsSpent  Int     @default(0)

  // Engagement
  totalReadings     Int      @default(0)
  totalQuestions    Int      @default(0)
  loginStreak       Int      @default(1)
  lastLoginDate     DateTime @default(now())
  welcomeCompleted  Boolean  @default(false)

  // Referral System
  referralCode      String   @unique
  referredById      String?
  referredBy        User?    @relation("Referrals", fields: [referredById], references: [id])
  referrals         User[]   @relation("Referrals")

  // Admin
  isAdmin           Boolean  @default(false)
  accountStatus     AccountStatus @default(ACTIVE)

  // Relations
  readings          Reading[]
  transactions      Transaction[]
  achievements      UserAchievement[]
  horoscopeCache    HoroscopeCache[]

  @@index([email])
  @@index([referralCode])
}

enum AccountStatus {
  ACTIVE
  FLAGGED
  SUSPENDED
}

// ============================================
// TAROT READINGS
// ============================================

model Reading {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Reading Details
  spreadType      SpreadType
  interpretationStyle InterpretationStyle
  question        String?

  // Cards (stored as JSON)
  cards           Json     // Array of { cardId, position, isReversed }

  // AI Response
  interpretation  String   @db.Text

  // Post-reading enrichment
  summary         String?  @db.Text    // Short summary for personalization (generated later)
  userReflection  String?  @db.Text    // User's optional reflection after reading
  themes          String[]             // Extracted themes like ["career", "transition", "fear"]

  // Metadata
  creditCost      Int
  createdAt       DateTime @default(now())

  // Follow-up questions
  followUps       FollowUpQuestion[]

  // Normalized cards for RAG queries
  normalizedCards ReadingCard[]

  @@index([userId])
  @@index([createdAt])
  @@index([spreadType])
}

model FollowUpQuestion {
  id          String   @id @default(cuid())
  readingId   String
  reading     Reading  @relation(fields: [readingId], references: [id], onDelete: Cascade)

  question    String
  answer      String   @db.Text
  creditCost  Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([readingId])
}

model ReadingCard {
  id         String   @id @default(cuid())
  readingId  String
  reading    Reading  @relation(fields: [readingId], references: [id], onDelete: Cascade)

  cardId     Int      // References card from constants (0-77)
  position   Int      // Position in spread (0-indexed)
  isReversed Boolean  @default(false)

  createdAt  DateTime @default(now())

  @@unique([readingId, position])
  @@index([readingId])
  @@index([cardId])
}

enum SpreadType {
  SINGLE
  THREE_CARD
  LOVE
  CAREER
  HORSESHOE
  CELTIC_CROSS
}

enum InterpretationStyle {
  CLASSIC
  SPIRITUAL
  PSYCHO_EMOTIONAL
  NUMEROLOGY
  ELEMENTAL
}

// ============================================
// HOROSCOPE CACHING
// ============================================

model HoroscopeCache {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  sign        String   // zodiac sign
  language    String   // 'en' | 'fr'
  date        DateTime @db.Date // The date this horoscope is for

  // Content
  horoscope   String   @db.Text

  // Q&A Cache
  questions   HoroscopeQA[]

  createdAt   DateTime @default(now())

  @@unique([sign, language, date])
  @@index([sign, date])
  @@index([date])
}

model HoroscopeQA {
  id              String   @id @default(cuid())
  horoscopeCacheId String
  horoscopeCache  HoroscopeCache @relation(fields: [horoscopeCacheId], references: [id], onDelete: Cascade)

  question        String
  answer          String   @db.Text
  createdAt       DateTime @default(now())

  @@index([horoscopeCacheId])
}

// ============================================
// TRANSACTIONS & PAYMENTS
// ============================================

model Transaction {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Transaction Details
  type            TransactionType
  amount          Int      // Credits amount (positive for purchases, negative for spending)
  description     String

  // Payment Info (for purchases)
  paymentProvider PaymentProvider?
  paymentId       String?  // Stripe/PayPal transaction ID
  paymentAmount   Decimal? @db.Decimal(10, 2) // Actual money amount
  currency        String?  @default("EUR")
  paymentStatus   PaymentStatus?

  createdAt       DateTime @default(now())

  @@index([userId])
  @@index([paymentId])
  @@index([createdAt])
  @@index([type])
}

enum TransactionType {
  PURCHASE        // Bought credits
  READING         // Spent on reading
  QUESTION        // Spent on follow-up question
  DAILY_BONUS     // Daily login reward
  ACHIEVEMENT     // Achievement reward
  REFERRAL_BONUS  // Referral reward
  REFUND          // Refunded credits
}

enum PaymentProvider {
  STRIPE
  STRIPE_LINK
  PAYPAL
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// ============================================
// ACHIEVEMENTS & GAMIFICATION
// ============================================

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  achievementId String   // e.g., 'first_reading', 'week_streak'
  unlockedAt    DateTime @default(now())

  @@unique([userId, achievementId])
  @@index([userId])
}

// ============================================
// EMAIL & MARKETING (Brevo integration)
// ============================================

model EmailSubscription {
  id          String   @id @default(cuid())
  email       String   @unique

  // Consent
  newsletter  Boolean  @default(false)
  marketing   Boolean  @default(false)

  // Brevo sync
  brevoContactId String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
}

// ============================================
// CREDIT PACKAGES (Admin-managed)
// ============================================

model CreditPackage {
  id          String   @id @default(cuid())

  // Package details
  credits     Int
  priceEur    Decimal  @db.Decimal(10, 2)

  // Display names
  nameEn      String
  nameFr      String
  labelEn     String   // e.g., "Best Value"
  labelFr     String

  // Marketing
  discount    Int      @default(0)  // Percentage discount shown
  badge       String?  // e.g., "POPULAR", "BEST_VALUE"

  // Status
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// EMAIL TEMPLATES (Admin-managed)
// ============================================

model EmailTemplate {
  id          String   @id @default(cuid())

  // Template identifier
  slug        String   @unique  // e.g., "welcome", "purchase_confirmation"

  // Content - English
  subjectEn   String
  bodyEn      String   @db.Text

  // Content - French
  subjectFr   String
  bodyFr      String   @db.Text

  // Status
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// LOCALIZATION (Dynamic translations)
// ============================================

model Language {
  id          String   @id @default(cuid())
  code        String   @unique  // e.g., "en", "fr", "es"
  name        String             // e.g., "English", "Français"
  nativeName  String             // e.g., "English", "Français"
  isActive    Boolean  @default(true)
  isDefault   Boolean  @default(false)
  sortOrder   Int      @default(0)

  translations Translation[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Translation {
  id          String   @id @default(cuid())

  // Translation key (e.g., "nav.home", "tarot.shuffle")
  key         String

  // The translated value
  value       String   @db.Text

  // Language relation
  languageId  String
  language    Language @relation(fields: [languageId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, languageId])
  @@index([languageId])
}

// ============================================
// SYSTEM SETTINGS (Runtime configuration)
// ============================================

model SystemSetting {
  id          String   @id @default(cuid())

  // Setting key (e.g., "OPENROUTER_API_KEY", "AI_MODEL")
  key         String   @unique

  // The value (encrypted for secrets)
  value       String   @db.Text

  // Metadata
  isSecret    Boolean  @default(false)  // If true, mask in UI
  description String?  // Human-readable description

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// CACHE VERSION TRACKING
// ============================================

model CacheVersion {
  id        String   @id @default(cuid())
  entity    String   @unique  // e.g., "translations", "credit_packages"
  version   Int      @default(1)
  updatedAt DateTime @updatedAt
}

// ============================================
// BLOG CMS
// ============================================

model BlogPost {
  id              String   @id @default(cuid())

  // URL slug (unique, SEO-friendly)
  slug            String   @unique

  // Content - English (required)
  titleEn         String
  excerptEn       String   @default("") @db.Text  // Short description for cards/SEO
  contentEn       String   @default("") @db.Text  // Rich text HTML content

  // Content - French (optional - can add later)
  titleFr         String   @default("")
  excerptFr       String   @default("") @db.Text
  contentFr       String   @default("") @db.Text

  // Media
  coverImage      String?  // URL to cover image
  coverImageAlt   String?  // Alt text for accessibility/SEO

  // SEO Meta (optional overrides)
  metaTitleEn     String?  // Override for <title> tag
  metaTitleFr     String?
  metaDescEn      String?  // Override for meta description
  metaDescFr      String?
  ogImage         String?  // Override Open Graph image

  // Author & Status
  authorId        String?  // Optional link to User
  authorName      String   // Displayed author name
  status          BlogPostStatus @default(DRAFT)
  featured        Boolean  @default(false)

  // Engagement
  viewCount       Int      @default(0)
  readTimeMinutes Int      @default(5)

  // Timestamps
  publishedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Soft delete
  deletedAt       DateTime?  // If set, post is in trash
  originalSlug    String?    // Original slug before deletion (for restore)

  // Admin ordering (for category-based ordering in admin panel)
  sortOrder       Int        @default(0)

  // Relations
  categories      BlogPostCategory[]
  tags            BlogPostTag[]

  @@index([slug])
  @@index([status, publishedAt])
  @@index([featured])
  @@index([deletedAt])
  @@index([sortOrder])
}

enum BlogPostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model BlogCategory {
  id          String   @id @default(cuid())

  // URL slug
  slug        String   @unique

  // Names
  nameEn      String
  nameFr      String
  descEn      String?  @db.Text
  descFr      String?  @db.Text

  // Display
  color       String?  // Hex color for badges
  icon        String?  // Lucide icon name
  sortOrder   Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  posts       BlogPostCategory[]

  @@index([slug])
}

model BlogTag {
  id          String   @id @default(cuid())

  // URL slug
  slug        String   @unique

  // Names
  nameEn      String
  nameFr      String

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  posts       BlogPostTag[]

  @@index([slug])
}

// Many-to-many join tables
model BlogPostCategory {
  id          String   @id @default(cuid())
  postId      String
  categoryId  String

  post        BlogPost     @relation(fields: [postId], references: [id], onDelete: Cascade)
  category    BlogCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([postId, categoryId])
  @@index([postId])
  @@index([categoryId])
}

model BlogPostTag {
  id          String   @id @default(cuid())
  postId      String
  tagId       String

  post        BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag         BlogTag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([postId, tagId])
  @@index([postId])
  @@index([tagId])
}

// Media uploads for blog
model MediaUpload {
  id          String   @id @default(cuid())

  // File info
  filename    String
  originalName String
  mimeType    String
  size        Int      // bytes
  url         String   // Public URL

  // Metadata
  altText     String?
  caption     String?

  // Organization
  folder      String   @default("blog")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([folder])
}

// ============================================
// TAROT ARTICLES (GEO-Optimized Content)
// ============================================

// Enums for Tarot Cards
enum CardType {
  MAJOR_ARCANA      @map("Major Arcana")
  SUIT_OF_WANDS     @map("Suit of Wands")
  SUIT_OF_CUPS      @map("Suit of Cups")
  SUIT_OF_SWORDS    @map("Suit of Swords")
  SUIT_OF_PENTACLES @map("Suit of Pentacles")
}

enum Element {
  FIRE
  WATER
  AIR
  EARTH
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

// Main Tarot Article Model
model TarotArticle {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Content
  title              String
  slug               String   @unique
  excerpt            String
  content            String   @db.Text
  author             String
  readTime           String

  // Dates (for schema)
  datePublished      DateTime
  dateModified       DateTime

  // Images
  featuredImage      String
  featuredImageAlt   String

  // Card Metadata
  cardType                   CardType
  cardNumber                 String
  astrologicalCorrespondence String
  element                    Element

  // Taxonomy (stored as JSON arrays)
  categories         String[]
  tags               String[]

  // SEO
  seoFocusKeyword    String
  seoMetaTitle       String
  seoMetaDescription String

  // FAQ (stored as JSON)
  faq                Json     // Array of { question: string, answer: string }

  // Breadcrumbs
  breadcrumbCategory    String
  breadcrumbCategoryUrl String?

  // Related Content
  relatedCards       String[]

  // Flags
  isCourtCard        Boolean  @default(false)
  isChallengeCard    Boolean  @default(false)

  // Generated Schema (stored for performance)
  schemaJson         Json     // The complete JSON-LD schema
  schemaHtml         String   @db.Text

  // Publishing
  status             ArticleStatus @default(DRAFT)
  publishedAt        DateTime?

  // Soft delete
  deletedAt          DateTime?  // If set, article is in trash
  originalSlug       String?    // Original slug before deletion (for restore)

  // Admin ordering (per card type)
  sortOrder          Int      @default(0)

  // Indexes for common queries
  @@index([cardType])
  @@index([status])
  @@index([slug])
  @@index([datePublished])
  @@index([deletedAt])
  @@index([cardType, sortOrder])

  @@map("tarot_articles")
}

// Optional: Card Reference Table
model TarotCard {
  id          String   @id @default(cuid())

  name        String   @unique  // "The Fool", "Three of Cups"
  slug        String   @unique  // "the-fool", "three-of-cups"
  cardType    CardType
  cardNumber  String            // "0", "3", etc.
  element     Element

  // Correspondences
  astrologicalSign    String?
  astrologicalPlanet  String?
  hebrewLetter        String?

  // Quick reference
  uprightKeywords     String[]
  reversedKeywords    String[]

  // Relationships
  // article          TarotArticle? @relation(fields: [articleId], references: [id])
  // articleId        String?       @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tarot_cards")
}

// ============================================
// TAROT ARTICLE TAXONOMY (for editor management)
// ============================================

model TarotCategory {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("tarot_categories")
}

model TarotTag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tarot_tags")
}

model TarotMedia {
  id           String    @id @default(cuid())
  filename     String
  originalName String
  url          String
  mimeType     String
  size         Int
  altText      String?
  caption      String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  @@index([deletedAt])
  @@map("tarot_media")
}

// ============================================
// AUDIT LOGGING (GDPR & SOC2 Compliance)
// ============================================

model AuditLog {
  id          String   @id @default(cuid())

  // Who performed the action
  userId      String?  // Nullable for system actions
  adminUserId String?  // For admin-initiated actions

  // What happened
  action      String   // e.g., "USER_DATA_EXPORT", "ACCOUNT_DELETED", "CREDIT_ADJUSTMENT"
  entityType  String   // e.g., "User", "Reading", "Transaction"
  entityId    String?  // ID of affected entity

  // Details
  details     Json?    // Flexible metadata (before/after state, reason, etc.)
  ipAddress   String?
  userAgent   String?

  // Timestamp
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([adminUserId])
  @@index([action])
  @@index([createdAt])
  @@index([entityType, entityId])

  @@map("audit_logs")
}

model ConsentAuditLog {
  id             String   @id @default(cuid())

  userId         String

  // Consent details
  consentType    String   // e.g., "marketing", "newsletter", "terms", "privacy", "cookies"
  consented      Boolean
  consentVersion String?  // Version of terms/policy agreed to

  // Context
  ipAddress      String?
  userAgent      String?

  createdAt      DateTime @default(now())

  @@index([userId])
  @@index([consentType])
  @@index([createdAt])

  @@map("consent_audit_logs")
}
